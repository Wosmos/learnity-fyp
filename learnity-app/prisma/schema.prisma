// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User profile stored in Neon DB (single source of truth)
model User {
  id                String    @id @default(cuid())
  firebaseUid       String    @unique // Links to Firebase Auth user
  email             String    @unique
  firstName         String
  lastName          String
  role              UserRole
  emailVerified     Boolean   @default(false)
  profilePicture    String?   // Firebase Storage URL
  authProvider      String?   @default("email") // "email", "social"
  socialProviders   String[]  @default([]) // ["google.com", "microsoft.com"]
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  studentProfile    StudentProfile?
  teacherProfile    TeacherProfile?
  adminProfile      AdminProfile?
  auditLogs         AuditLog[]
  securityEvents    SecurityEvent[]
  
  // Indexes for optimal query performance
  @@index([firebaseUid])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([lastLoginAt])
  @@index([createdAt])
  @@map("users")
}

model StudentProfile {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  gradeLevel                  String
  subjects                    String[] // Array of subject interests
  learningGoals               String[] // Optional enhancements
  interests                   String[] // Optional enhancements
  studyPreferences            String[] // Optional enhancements
  bio                         String?  // Optional bio
  profileCompletionPercentage Int      @default(20) // Basic info = 20%
  
  // Privacy settings
  profileVisibility           ProfileVisibility @default(PUBLIC)
  showEmail                   Boolean  @default(false)
  showLearningGoals           Boolean  @default(true)
  showInterests               Boolean  @default(true)
  showProgress                Boolean  @default(true)
  allowMessages               Boolean  @default(true)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("student_profiles")
}

enum ProfileVisibility {
  PUBLIC
  FRIENDS
  PRIVATE
}

model TeacherProfile {
  id                String              @id @default(cuid())
  userId            String              @unique
  applicationStatus ApplicationStatus   @default(PENDING)
  qualifications    String[]
  subjects          String[]
  experience        Int                 // Years of experience
  bio               String?
  hourlyRate        Decimal?
  documents         String[]            // Vercel Blob URLs
  submittedAt       DateTime            @default(now())
  reviewedAt        DateTime?
  approvedBy        String?             // Admin user ID
  rejectionReason   String?
  
  // Enhanced Profile Fields
  profilePicture    String?             // Vercel Blob URL
  bannerImage       String?             // Vercel Blob URL
  phone             String?
  address           String?
  city              String?
  state             String?
  country           String?
  zipCode           String?
  dateOfBirth       DateTime?
  gender            String?
  
  // Professional profile fields (isTopRated calculated automatically)
  rating            Decimal             @default(0)
  reviewCount       Int                 @default(0)
  responseTime      String?             // e.g., "<1hr", "2-4hrs"
  availability      String?             // e.g., "Available today", "Weekends only"
  languages         String[]            @default([])
  timezone          String?
  videoIntroUrl     String?             // Vercel Blob URL for video introduction
  
  // Teaching details
  lessonsCompleted  Int                 @default(0)
  activeStudents    Int                 @default(0)
  teachingStyle     String?             // e.g., "Interactive", "Structured"
  specialties       String[]            @default([])
  certifications    String[]            @default([])
  education         String[]            @default([])
  
  // Enhanced Teaching Information
  teachingMethods   String[]            @default([]) // e.g., "Visual", "Auditory", "Kinesthetic"
  ageGroups         String[]            @default([]) // e.g., "Elementary", "Middle School", "High School", "Adult"
  lessonTypes       String[]            @default([]) // e.g., "One-on-One", "Group", "Workshop"
  onlineExperience  Int?                // Years of online teaching
  technologySkills  String[]            @default([]) // e.g., "Zoom", "Google Meet", "Interactive Whiteboards"
  
  // Availability schedule
  availableDays     String[]            @default([])
  preferredTimes    String[]            @default([])
  minSessionLength  Int?                // Minutes
  maxSessionLength  Int?                // Minutes
  
  // Additional info
  headline          String?             // Short catchy headline
  achievements      String[]            @default([])
  teachingApproach  String?             // Detailed teaching methodology
  personalInterests String[]            @default([])
  hobbies           String[]            @default([])
  
  // Social Media & Professional Links
  linkedinUrl       String?
  twitterUrl        String?
  facebookUrl       String?
  instagramUrl      String?
  websiteUrl        String?
  youtubeUrl        String?
  
  // Trust & credibility
  trustBadges       String[]            @default([]) // e.g., "Verified ID", "Background Check", "Top Rated"
  faqs              Json?               // Array of {question, answer} objects
  sampleLessons     Json?               // Array of {title, description, duration} objects
  successStories    Json?               // Array of {studentName, achievement, subject} objects
  whyChooseMe       String[]            @default([]) // Key differentiators
  
  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  
  // Preferences
  communicationPreference String?       // e.g., "Email", "Phone", "Text"
  notificationSettings    Json?         // Notification preferences
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes for teacher application queries
  @@index([applicationStatus])
  @@index([submittedAt])
  @@index([reviewedAt])
  @@index([approvedBy])
  @@index([rating])
  @@index([lessonsCompleted])
  @@index([city])
  @@index([country])
  @@index([subjects])
  @@map("teacher_profiles")
}

model AdminProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  department  String   @default("Platform Management")
  isStatic    Boolean  @default(false) // True for env-configured admin
  createdBy   String?  // Who created this admin
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("admin_profiles")
}

model AuditLog {
  id              String    @id @default(cuid())
  userId          String?   // Nullable for system events
  firebaseUid     String?
  eventType       EventType
  action          String
  resource        String?
  oldValues       Json?
  newValues       Json?
  ipAddress       String
  userAgent       String
  deviceFingerprint String?
  success         Boolean
  errorMessage    String?
  metadata        Json?
  createdAt       DateTime  @default(now())
  
  user User? @relation(fields: [userId], references: [id])
  
  // Indexes for audit log queries
  @@index([userId])
  @@index([firebaseUid])
  @@index([eventType])
  @@index([createdAt])
  @@index([success])
  @@index([ipAddress])
  @@map("audit_logs")
}

model SecurityEvent {
  id                String        @id @default(cuid())
  userId            String?
  firebaseUid       String?
  eventType         SecurityEventType
  riskLevel         RiskLevel
  ipAddress         String
  userAgent         String
  deviceFingerprint String
  blocked           Boolean       @default(false)
  reason            String?
  metadata          Json?
  createdAt         DateTime      @default(now())
  
  user User? @relation(fields: [userId], references: [id])
  
  // Indexes for security event queries
  @@index([userId])
  @@index([firebaseUid])
  @@index([eventType])
  @@index([riskLevel])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([blocked])
  @@map("security_events")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  PENDING_TEACHER
  REJECTED_TEACHER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  AUTH_LOGIN
  AUTH_LOGOUT
  AUTH_REGISTER
  AUTH_PASSWORD_RESET
  AUTH_EMAIL_VERIFY
  PROFILE_UPDATE
  ROLE_CHANGE
  TEACHER_APPLICATION_SUBMIT
  TEACHER_APPLICATION_APPROVE
  TEACHER_APPLICATION_REJECT
  ADMIN_ACTION
}

enum SecurityEventType {
  SUSPICIOUS_LOGIN
  RATE_LIMIT_EXCEEDED
  BOT_DETECTED
  MULTIPLE_FAILED_ATTEMPTS
  NEW_DEVICE_LOGIN
  UNUSUAL_ACTIVITY
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model AdminAction {
  id           String   @id @default(cuid())
  adminId      String   // Firebase UID of admin who performed action
  action       String   // e.g., "teacher_approve", "teacher_reject", "user_suspend"
  targetUserId String?  // User affected by the action
  details      Json?    // Additional action details
  createdAt    DateTime @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("admin_actions")
}

model Testimonial {
  id          String   @id @default(cuid())
  teacherId   String
  studentName String
  rating      Int      // 1-5
  comment     String
  subject     String?
  date        DateTime @default(now())
  isVerified  Boolean  @default(true)
  
  @@index([teacherId])
  @@index([rating])
  @@map("testimonials")
}